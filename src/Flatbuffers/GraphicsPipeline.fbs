include			"Eldritch2Types.fbs";
include			"GraphicsTypes.fbs";

file_identifier	"E2GP";
file_extension	".e2graphicspipeline";

namespace Eldritch2.Graphics.FlatBuffers;

enum AttachmentFlags : uint (bit_flags) {
	Persistent
}

enum SourceConcept : ubyte {
	StaticMeshes,
	Meshes
}

struct DynamicDimensions {
	Width  : float = 1.0;
	Height : float = 1.0;
}

struct StaticDimensions {
	Width  : uint;
	Height : uint;
	Depth  : uint = 1;
}

union PassDimensions {
	DynamicDimensions,
	StaticDimensions
}

struct AttachmentReference {
	GlobalIndex : uint;
	Mip         : uint = 0;
	FirstSlice  : uint = 0;
	LastSlice   : uint = 0xFFFFFFFF;
}

table DrawStage {
	Dimensions       : PassDimensions        (required);
	ShaderUsageName  : string                (required);
	SourceConcepts   : [SourceConcept]       (required);
	DepthAttachment  : AttachmentReference;
	InputAttachments : [AttachmentReference] (required);
	ColorAttachments : [AttachmentReference] (required);
}

table CopyStage {
	Source : AttachmentReference (required);
	Target : AttachmentReference (required);
}

table ComputeStage {
	Dimensions  : PassDimensions        (required);
	ShaderName  : string                (required);
	Attachments : [AttachmentReference] (required);
}

union PipelineStage {
	DrawStage,
	CopyStage,
	ComputeStage
}

table AttachmentDescriptor {
	Name        : string (required, key);
	Format      : GpuFormat;
	Flags       : AttachmentFlags;
	SmallestMip : ushort;
}

table GraphicsPipelineDescriptor {
	Attachments  : [AttachmentDescriptor] (required);
	SharedImages : [uint]                 (required);
	Stages       : [PipelineStage]        (required);
}

root_type GraphicsPipelineDescriptor;